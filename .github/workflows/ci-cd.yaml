# .github/workflows/ci-cd.yml
name: Backend CI/CD Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

env:
  GIT_URL: "https://github.com/8-do-nenemddin/DECASE-BE.git"
  GIT_BRANCH: "main"
  IMAGE_NAME: "sk-team-08-decase"
  IMAGE_TAG: "1.0.0"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Clone Repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Generate Hash Code and Final Image Tag
        id: tag
        run: |
          HASHCODE=$(date +%s%N | sha256sum | cut -c1-12)

          FINAL_IMAGE_TAG="${{ env.IMAGE_TAG }}-${{ github.run_number }}-${HASHCODE}"

          echo "Generated Hash Code: ${HASHCODE}"
          echo "Final Image Tag: ${FINAL_IMAGE_TAG}"

          echo "FINAL_IMAGE_TAG=${FINAL_IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "HASHCODE=${HASHCODE}" >> $GITHUB_OUTPUT

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - name: ğŸ”§ Grant Execute Permission for Gradlew
        run: |
          echo "ğŸ”§ Setting execute permission for gradlew..."
          chmod +x ./gradlew
          echo "âœ… Gradlew permission set successfully"

      - name: ğŸ“¦ Build with Gradle
        run: |
          echo "ğŸ—ï¸ Building Spring Boot application with Gradle..."

          echo "ğŸ“‹ Gradle version:"
          ./gradlew --version

          echo "ğŸ§¹ Cleaning previous builds..."
          ./gradlew clean

          echo "ğŸ”¨ Building application (skipping tests for faster build)..."
          ./gradlew build -x test

          echo "ğŸ“ Build output:"
          ls -la build/libs/

          echo "âœ… Gradle build completed successfully"

      - name: ğŸ§ª Run Tests (Optional)
        run: |
          echo "ğŸ§ª Running Spring Boot tests..."
          # ./gradlew test
          echo "âœ… Tests completed (skipped for faster CI/CD)"

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.IMAGE_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Docker Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.FINAL_IMAGE_TAG }}
            ${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: |
            type=gha
            type=registry,ref=${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:cache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:cache,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: ğŸ“ Update deploy.yaml and Git Push
        run: |
          echo "ğŸ“ Updating deploy.yaml with new image..."

          NEW_IMAGE="${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.FINAL_IMAGE_TAG }}"

          echo "ğŸ”„ New image: ${NEW_IMAGE}"

          # initContainersì˜ image ì—…ë°ì´íŠ¸
          sed -i 's|image: amdp-registry.skala-ai.com/skala25a/sk-team-08-decase:.*|image: '"${NEW_IMAGE}"'|g' ./k8s/deploy.yaml

          # containersì˜ image ì—…ë°ì´íŠ¸ 
          sed -i '/containers:/,/volumeMounts:/ s|image: amdp-registry.skala-ai.com/skala25a/sk-team-08-decase:.*|image: '"${NEW_IMAGE}"'|g' ./k8s/deploy.yaml

          # update annotation ì—…ë°ì´íŠ¸ (ArgoCD ë™ê¸°í™”ìš©)
          HASH=$(echo $RANDOM | md5sum | head -c 32)
          sed -i "s|update: .*|update: ${HASH}|g" ./k8s/deploy.yaml

          echo "ğŸ“‹ Updated deploy.yaml content (image lines only):"
          grep -A 1 -B 1 "image: amdp-registry" ./k8s/deploy.yaml || echo "Image lines updated"

      - name: ğŸ“¤ Commit and Push Changes to Repository
        run: |
          echo "ğŸ“¤ Committing and pushing changes..."

          # Secretsì—ì„œ Git ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          git config user.name "${{ secrets.GIT_USER_NAME }}"
          git config user.email "${{ secrets.GIT_USER_EMAIL }}"

          # deploy.yaml íŒŒì¼ì„ ìŠ¤í…Œì´ì§• ì˜ì—­ì— ì¶”ê°€
          git add ./k8s/deploy.yaml || true

          # ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ì»¤ë°‹ ë° í‘¸ì‹œ
          if ! git diff --cached --quiet; then
            echo "âœ… Changes detected, committing..."
            
            # ì»¤ë°‹ ë©”ì‹œì§€ (ë¬´í•œë£¨í”„ ë°©ì§€ìš© [skip ci] íƒœê·¸ í¬í•¨)
            git commit -m "[AUTO] Update Backend deploy.yaml with image ${{ steps.tag.outputs.FINAL_IMAGE_TAG }} [skip ci]"
            
            echo "ğŸ“¤ Pushing to repository..."
            git push origin ${{ env.GIT_BRANCH }}
            
            echo "âœ… Successfully pushed manifest update to repository"
          else
            echo "â„¹ï¸ No changes to commit."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Pipeline Summary
        run: |
          echo "ğŸ‰ Backend CI/CD Pipeline Completed Successfully!"
          echo ""
          echo "ğŸ“‹ Pipeline Summary:"
          echo "â”œâ”€â”€ â˜• Spring Boot Application Built with Java 21"
          echo "â”œâ”€â”€ ğŸ“¦ Backend Image: ${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.FINAL_IMAGE_TAG }}"
          echo "â”œâ”€â”€ ğŸ·ï¸ Hash Code: ${{ steps.tag.outputs.HASHCODE }}"
          echo "â”œâ”€â”€ ğŸ”¢ Build Number: ${{ github.run_number }}"
          echo "â”œâ”€â”€ ğŸ“ Updated deploy.yaml (initContainers + containers)"
          echo "â”œâ”€â”€ ğŸ“¤ Pushed changes to repository"
          echo "â””â”€â”€ ğŸ”„ ArgoCD will automatically sync and deploy this change"
          echo ""
          echo "ğŸŒ Backend API will be available at: https://decase.skala25a.project.skala-ai.com/api/v1"
          echo "ğŸ“Š Management port: https://decase.skala25a.project.skala-ai.com:8081/actuator"
          echo "ğŸ“ˆ ArgoCD Dashboard: Check your ArgoCD UI for deployment status"
